<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Low Stock Finder</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 24px; color: #111; background: #fafafa; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    label { font-size: 14px; color: #374151; display: block; margin-bottom: 6px; }
    input[type="number"], input[type="file"] { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; background: #fff; }
    input[type="number"]:focus, input[type="file"]:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #1f2937; background: #111827; color: #fff; font-size: 14px; cursor: pointer; }
    button:disabled { opacity: .45; cursor: not-allowed; }
    .actions { display: flex; gap: 10px; align-items: center; }
    .muted { color: #6b7280; font-size: 13px; }
    .pill { display: inline-block; background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 13px; }
    th { background: #f9fafb; }
    .footer { margin-top: 16px; font-size: 12px; color: #6b7280; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Low Stock Finder</h1>
  <div class="card">
    <div class="row">
      <div>
        <label for="csvFile">Upload inventory CSV</label>
        <input id="csvFile" type="file" accept=".csv">
      </div>
      <div>
        <label for="threshold">Floor threshold (Available on Sales Floor ≤ X)</label>
        <input id="threshold" type="number" min="0" step="1" placeholder="Enter a number, like 2">
      </div>
    </div>
    <div class="actions" style="margin-top:12px;">
      <!-- Analyze button is always enabled; script will warn if no file -->
      <button id="analyzeBtn">Analyze</button>
      <button id="downloadBtn" class="ok" disabled>Download Low Stock CSV</button>
      <span id="status" class="muted">Waiting for file...</span>
    </div>
    <div id="summary" class="list muted"></div>
  </div>

  <div id="resultsCard" class="card" style="margin-top:18px;">
    <div class="actions" style="justify-content: space-between;">
      <div>
        <span class="pill">Sales Floor ≤ threshold</span>
        <span class="pill">Day Vault = 0</span>
        <span class="pill">Vault &gt; 0</span>
      </div>
      <div class="muted">Columns used: Product, Available, Room, Batch, External ID</div>
    </div>
    <h2 style="margin:14px 0 6px; font-size:16px;">Low stock list</h2>
    <div id="lowListEmpty" class="muted">No items yet.</div>
    <table id="lowListTable" class="hidden">
      <thead>
        <tr>
          <th>Product</th>
          <th>Sales Floor Available</th>
          <th>Day Vault Available</th>
          <th>Vault Available</th>
          <th>Batch</th>
          <th>External ID</th>
        </tr>
      </thead>
      <tbody id="lowListBody"></tbody>
    </table>
    <div class="footer">Tip: The tool groups by Product and sums “Available” per Room. Make sure your CSV headers match “Product”, “Room”, “Available”, “Batch”, and your external ID column (e.g. “External package ID”).</div>
  </div>

<script>
// Basic CSV parser; returns an array of rows (arrays of strings)
function parseCSV(text) {
  var rows = [];
  var cur = '';
  var row = [];
  var inQuotes = false;
  for (var i = 0; i < text.length; i++) {
    var ch = text.charAt(i);
    if (inQuotes) {
      if (ch === '"') {
        if (text.charAt(i + 1) === '"') {
          cur += '"';
          i++;
        } else {
          inQuotes = false;
        }
      } else {
        cur += ch;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
      } else if (ch === ',') {
        row.push(cur);
        cur = '';
      } else if (ch === '\n') {
        row.push(cur);
        rows.push(row);
        row = [];
        cur = '';
      } else if (ch === '\r') {
        // skip CR
      } else {
        cur += ch;
      }
    }
  }
  row.push(cur);
  rows.push(row);
  return rows;
}

// Convert rows back to CSV string
function toCSV(rows) {
  var out = [];
  for (var i = 0; i < rows.length; i++) {
    var cells = rows[i];
    var line = [];
    for (var j = 0; j < cells.length; j++) {
      var s = String(cells[j] == null ? '' : cells[j]);
      if (s.indexOf('"') >= 0 || s.indexOf(',') >= 0 || s.indexOf('\n') >= 0) {
        s = '"' + s.replace(/"/g, '""') + '"';
      }
      line.push(s);
    }
    out.push(line.join(','));
  }
  return out.join('\n');
}

function getEl(id) { return document.getElementById(id); }

function updateStatus() {
  var fileInput = getEl('csvFile');
  var hasFile = fileInput.files && fileInput.files.length > 0;
  var threshRaw = getEl('threshold').value.trim();
  var threshold = parseInt(threshRaw, 10);
  var status = getEl('status');
  if (!hasFile) {
    status.textContent = 'Waiting for file...';
  } else if (!threshRaw || isNaN(threshold) || threshold < 0) {
    status.textContent = 'File ready (threshold optional, default 0)';
  } else {
    status.textContent = 'File ready; threshold set';
  }
}

getEl('csvFile').addEventListener('change', updateStatus);
getEl('threshold').addEventListener('input', updateStatus);

getEl('analyzeBtn').addEventListener('click', function() {
  var fileInput = getEl('csvFile');
  if (!(fileInput.files && fileInput.files.length > 0)) {
    getEl('status').textContent = 'Please select a CSV file first.';
    return;
  }
  var file = fileInput.files[0];
  var reader = new FileReader();
  reader.onload = function(e) {
    var text = e.target.result;
    var rows = parseCSV(text);
    if (!rows || rows.length === 0) {
      getEl('status').textContent = 'CSV is empty.';
      return;
    }
    var header = rows[0].map(function(h) { return (h || '').trim(); });
    var data = rows.slice(1);
    // Find columns
    var idxProduct = header.findIndex(function(h){ return h.toLowerCase() === 'product'; });
    var idxAvailable = header.findIndex(function(h){ return h.toLowerCase() === 'available'; });
    var idxRoom = header.findIndex(function(h){ return h.toLowerCase() === 'room'; });
    var idxBatch = header.findIndex(function(h){ return h.toLowerCase() === 'batch'; });
    var idxExternal = header.findIndex(function(h){ return h.toLowerCase().indexOf('external') !== -1; });
    if (idxProduct === -1 || idxAvailable === -1 || idxRoom === -1) {
      getEl('status').textContent = 'Missing required headers. Need Product, Available, and Room.';
      return;
    }
    // Parse threshold
    var threshRaw = getEl('threshold').value.trim();
    var threshold = parseInt(threshRaw, 10);
    if (isNaN(threshold) || threshold < 0) threshold = 0;
    // Group by product
    var byProduct = {};
    for (var i = 0; i < data.length; i++) {
      var r = data[i];
      var product = (r[idxProduct] || '').trim();
      var room = (r[idxRoom] || '').trim().toUpperCase();
      var availRaw = (r[idxAvailable] || '0').toString().trim();
      var available = parseFloat(availRaw.replace(/,/g, '')) || 0;
      if (!product) continue;
      if (!byProduct[product]) {
        byProduct[product] = { product: product, floor: 0, dayVault: 0, vault: 0, batches: [], externals: [] };
      }
      var rec = byProduct[product];
      if (room === 'SALES FLOOR') rec.floor += available;
      else if (room === 'DAY VAULT') rec.dayVault += available;
      else if (room === 'VAULT') rec.vault += available;
      if (idxBatch !== -1) {
        var batchVal = (r[idxBatch] || '').toString().trim();
        if (batchVal && rec.batches.indexOf(batchVal) === -1) rec.batches.push(batchVal);
      }
      if (idxExternal !== -1) {
        var extVal = (r[idxExternal] || '').toString().trim();
        if (extVal && rec.externals.indexOf(extVal) === -1) rec.externals.push(extVal);
      }
    }
    // Build low list
    var list = [];
    var productNames = Object.keys(byProduct).sort();
    for (var idx = 0; idx < productNames.length; idx++) {
      var name = productNames[idx];
      var item = byProduct[name];
      if (item.floor <= threshold && item.dayVault === 0 && item.vault > 0) {
        list.push({
          product: item.product,
          floor: item.floor,
          dayVault: item.dayVault,
          vault: item.vault,
          batch: item.batches.join(', '),
          external: item.externals.join(', ')
        });
      }
    }
    // Render table
    var tbody = getEl('lowListBody');
    tbody.innerHTML = '';
    if (list.length === 0) {
      getEl('lowListTable').classList.add('hidden');
      getEl('lowListEmpty').classList.remove('hidden');
    } else {
      getEl('lowListEmpty').classList.add('hidden');
      getEl('lowListTable').classList.remove('hidden');
      for (var k = 0; k < list.length; k++) {
        var it = list[k];
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>'+escapeHtml(it.product)+'</td>'+
                       '<td>'+it.floor+'</td>'+
                       '<td>'+it.dayVault+'</td>'+
                       '<td>'+it.vault+'</td>'+
                       '<td>'+escapeHtml(it.batch)+'</td>'+
                       '<td>'+escapeHtml(it.external)+'</td>';
        tbody.appendChild(tr);
      }
    }
    // Update summary and enable download
    var total = Object.keys(byProduct).length;
    getEl('summary').innerHTML = 'Analyzed '+total+' products. Found <strong>'+list.length+'</strong> low stock items at Sales Floor ≤ '+threshold+', Day Vault = 0, Vault &gt; 0.';
    getEl('downloadBtn').disabled = list.length === 0;
    // Save lowRows for CSV download
    window.__lowRows = list;
    getEl('status').textContent = list.length ? 'Done' : 'Done, no matches';
  };
  reader.readAsText(file);
});

getEl('downloadBtn').addEventListener('click', function() {
  var list = window.__lowRows || [];
  if (!list.length) return;
  var rows = [];
  rows.push(['Product','Sales Floor Available','Day Vault Available','Vault Available','Batch','External ID']);
  for (var i = 0; i < list.length; i++) {
    var it = list[i];
    rows.push([it.product, it.floor, it.dayVault, it.vault, it.batch, it.external]);
  }
  var csv = toCSV(rows);
  var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'low-stock-list.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 100);
});

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; });
}

// Initial status
updateStatus();
</script>
</body>
</html>